apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: msteams-config
  labels:
    app: alertmanager
spec:
  route:
    groupBy: ['alertname', 'job', 'namespace']
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h
    receiver: msteams
    routes:
      - receiver: "null"
        matchers:
          - matchType: "=~"
            name: alertname
            value: "Watchdog|InfoInhibitor"
      - receiver: msteams-critical
        matchers:
          - matchType: "="
            name: severity
            value: critical
        groupWait: 10s
        groupInterval: 1m
        repeatInterval: 1h
        continue: false
      - receiver: msteams
        matchers:
          - matchType: "="
            name: severity
            value: warning
        groupWait: 30s
        groupInterval: 5m
        repeatInterval: 4h
      - receiver: msteams
  inhibitRules:
    - sourceMatch:
        - matchType: "="
          name: severity
          value: critical
      targetMatch:
        - matchType: "="
          name: severity
          value: warning
      equal: ["alertname", "namespace"]
  receivers:
    - name: "null"
    - name: msteams
      msteamsConfigs:
        - sendResolved: true
          webhookUrl:
            name: alertmanager-msteams-secret
            key: webhook-url
          title: |-
            {{ if eq .Status "firing" }}ðŸ”´{{ else }}ðŸŸ¢{{ end }} [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
          text: |-
            {{ if eq .Status "firing" }}
            âš ï¸ **ALERT FIRING** - Immediate attention required
            {{ else }}
            âœ… **ALERT RESOLVED** - Issue has been remediated
            {{ end }}

            ---

            **ðŸ·ï¸ Alert Information**

            | Field | Value |
            |-------|-------|
            | **Cluster** | `{{ .CommonLabels.cluster }}` |
            | **Alert** | `{{ .CommonLabels.alertname }}` |
            | **Severity** | {{ if eq .CommonLabels.severity "critical" }}ðŸ”´ **CRITICAL**{{ else if eq .CommonLabels.severity "warning" }}ðŸŸ¡ **WARNING**{{ else }}ðŸ”µ **{{ .CommonLabels.severity | toUpper }}**{{ end }} |
            {{ if .CommonLabels.namespace }}| **Namespace** | `{{ .CommonLabels.namespace }}` |{{ end }}
            {{ if .CommonLabels.service }}| **Service** | `{{ .CommonLabels.service }}` |{{ end }}

            ---

            {{ range $alert := .Alerts }}

            ---

            **ðŸ“‹ Alert Details**

            {{ if $alert.Annotations.summary }}
            > **Summary**: {{ $alert.Annotations.summary }}
            {{ end }}

            {{ if $alert.Annotations.description }}
            > **Description**: {{ $alert.Annotations.description }}
            {{ end }}

            {{ if $alert.Annotations.runbook_url }}
            ðŸ“– **Runbook**: [View Runbook]({{ $alert.Annotations.runbook_url }})
            {{ end }}

            **Labels:**
            {{ if $alert.Labels.pod }}- **Pod**: `{{ $alert.Labels.pod }}`{{ end }}
            {{ if $alert.Labels.container }}- **Container**: `{{ $alert.Labels.container }}`{{ end }}
            {{ if $alert.Labels.instance }}- **Instance**: `{{ $alert.Labels.instance }}`{{ end }}
            {{ if $alert.Labels.node }}- **Node**: `{{ $alert.Labels.node }}`{{ end }}
            {{ if $alert.Labels.job }}- **Job**: `{{ $alert.Labels.job }}`{{ end }}

            **Timestamps:**
            - **Started**: {{ $alert.StartsAt.Format "2006-01-02 15:04:05 MST" }}
            {{ if $alert.EndsAt.IsZero | not }}- **Ended**: {{ $alert.EndsAt.Format "2006-01-02 15:04:05 MST" }}{{ end }}

            {{ end }}

            ---

            **ðŸ”— Quick Links**

            - [ðŸ“Š Grafana Dashboard](https://grafana.ops.techsecom.io)
            - [ðŸ”” Alertmanager](https://alertmanager.ops.techsecom.io)
            - [ðŸ“ˆ Prometheus](https://prometheus.ops.techsecom.io)
            - [ðŸ“ Loki Logs](https://grafana.ops.techsecom.io/explore?orgId=1&left=%5B%22now-1h%22,%22now%22,%22Loki%22,%7B%7D%5D)

            ---

            **ðŸ“ž Escalation Path:**
            1. Check Grafana dashboards for anomalies
            2. Review logs in Loki for error context
            3. If critical, escalate to on-call team
            4. Document incident in tracking system
    - name: msteams-critical
      msteamsConfigs:
        - sendResolved: true
          webhookUrl:
            name: alertmanager-msteams-secret
            key: webhook-url
          title: 'ðŸš¨ CRITICAL: {{ .CommonLabels.alertname }} on {{ .CommonLabels.cluster }}'
          text: |-
            **ðŸš¨ðŸš¨ðŸš¨ CRITICAL ALERT - IMMEDIATE ACTION REQUIRED ðŸš¨ðŸš¨ðŸš¨**

            ---

            | Field | Value |
            |-------|-------|
            | **Cluster** | `{{ .CommonLabels.cluster }}` |
            | **Alert** | `{{ .CommonLabels.alertname }}` |
            | **Severity** | ðŸ”´ **CRITICAL** |
            {{ if .CommonLabels.namespace }}| **Namespace** | `{{ .CommonLabels.namespace }}` |{{ end }}
            {{ if .CommonLabels.pod }}| **Pod** | `{{ .CommonLabels.pod }}` |{{ end }}
            {{ if .CommonLabels.node }}| **Node** | `{{ .CommonLabels.node }}` |{{ end }}

            ---

            {{ range $index, $alert := .Alerts }}
            {{ if $alert.Annotations.summary }}> {{ $alert.Annotations.summary }}{{ end }}

            {{ if $alert.Annotations.description }}**Details**: {{ $alert.Annotations.description }}{{ end }}

            **Started**: {{ $alert.StartsAt.Format "2006-01-02 15:04:05 MST" }}
            {{ end }}

            ---

            **âš¡ Immediate Actions:**
            1. **STOP** - Acknowledge this alert
            2. **ASSESS** - Check [Grafana](https://grafana.ops.techsecom.io) for impact
            3. **ACT** - Follow runbook or escalate immediately
            4. **COMMUNICATE** - Update stakeholders on status

            ðŸ”— [View Alert Source]({{ (index .Alerts 0).GeneratorURL }})
