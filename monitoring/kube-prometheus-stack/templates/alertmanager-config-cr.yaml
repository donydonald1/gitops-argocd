apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: msteams-config
  labels:
    app: alertmanager
spec:
  route:
    groupBy: ['alertname', 'job', 'namespace']
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h
    receiver: msteams
    routes:
      - receiver: "null"
        matchers:
          - matchType: "=~"
            name: alertname
            value: "Watchdog|InfoInhibitor"
      - receiver: msteams-critical
        matchers:
          - matchType: "="
            name: severity
            value: critical
        groupWait: 10s
        groupInterval: 1m
        repeatInterval: 1h
        continue: false
      - receiver: msteams
        matchers:
          - matchType: "="
            name: severity
            value: warning
        groupWait: 30s
        groupInterval: 5m
        repeatInterval: 4h
      - receiver: msteams
        matchers:
          - matchType: "="
            name: severity
            value: info
        groupWait: 30s
        groupInterval: 10m
        repeatInterval: 12h
      - receiver: msteams
  inhibitRules:
    - sourceMatch:
        - matchType: "="
          name: severity
          value: critical
      targetMatch:
        - matchType: "="
          name: severity
          value: warning
      equal: ["alertname", "namespace"]
  receivers:
    - name: "null"
    - name: msteams
      msteamsConfigs:
        - sendResolved: true
          webhookUrl:
            name: alertmanager-msteams-secret
            key: webhook-url
          title: '{{"{{"}} if eq .Status "firing" {{"}}"}}üîî{{"{{"}} else {{"}}"}}‚úÖ{{"{{"}} end {{"}}"}} {{"{{"}} .CommonLabels.alertname {{"}}"}}'
          text: |
            {{"{{"}} if eq .Status "resolved" {{"}}"}}**‚úÖ RESOLVED**{{"{{"}} end {{"}}"}}

            ---
            **üìä Alert Details**

            | Field | Value |
            |-------|-------|
            | **Status** | {{"{{"}} .Status | toUpper {{"}}"}} |
            | **Severity** | {{"{{"}} if eq .CommonLabels.severity "critical" {{"}}"}}üî¥ Critical{{"{{"}} else if eq .CommonLabels.severity "warning" {{"}}"}}üü† Warning{{"{{"}} else {{"}}"}}üîµ Info{{"{{"}} end {{"}}"}} |
            | **Cluster** | {{"{{"}} .CommonLabels.cluster {{"}}"}} |
            | **Namespace** | {{"{{"}} .CommonLabels.namespace {{"}}"}} |
            | **Alerts Count** | {{"{{"}} len .Alerts {{"}}"}} |

            ---
            {{"{{"}} range .Alerts {{"}}"}}
            **üìù {{"{{"}} .Annotations.summary {{"}}"}}**

            {{"{{"}} .Annotations.description {{"}}"}}

            {{"{{"}} if .Labels.pod {{"}}"}}**Pod:** {{"{{"}} .Labels.pod {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.container {{"}}"}}**Container:** {{"{{"}} .Labels.container {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.service {{"}}"}}**Service:** {{"{{"}} .Labels.service {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.node {{"}}"}}**Node:** {{"{{"}} .Labels.node {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.job {{"}}"}}**Job:** {{"{{"}} .Labels.job {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.instance {{"}}"}}**Instance:** {{"{{"}} .Labels.instance {{"}}"}}{{"{{"}} end {{"}}"}}

            **Started:** {{"{{"}} .StartsAt.Format "2006-01-02 15:04:05 UTC" {{"}}"}}
            {{"{{"}} if .EndsAt {{"}}"}}**Ended:** {{"{{"}} .EndsAt.Format "2006-01-02 15:04:05 UTC" {{"}}"}}{{"{{"}} end {{"}}"}}

            ---
            {{"{{"}} end {{"}}"}}
            **üîó Quick Links**
            [üìà Grafana](https://grafana.ops.techsecom.io) | [üîî Alertmanager](https://alertmanager.ops.techsecom.io) | [üìä Prometheus](https://prometheus.ops.techsecom.io)
    - name: msteams-critical
      msteamsConfigs:
        - sendResolved: true
          webhookUrl:
            name: alertmanager-msteams-secret
            key: webhook-url
          title: '{{"{{"}} if eq .Status "firing" {{"}}"}}üö® CRITICAL{{"{{"}} else {{"}}"}}‚úÖ RESOLVED{{"{{"}} end {{"}}"}}: {{"{{"}} .CommonLabels.alertname {{"}}"}}'
          text: |
            {{"{{"}} if eq .Status "resolved" {{"}}"}}
            **‚úÖ ALERT RESOLVED - Issue has been mitigated**
            {{"{{"}} else {{"}}"}}
            **üö® CRITICAL ALERT - IMMEDIATE ACTION REQUIRED**
            {{"{{"}} end {{"}}"}}

            ---
            **üìä Alert Details**

            | Field | Value |
            |-------|-------|
            | **Status** | {{"{{"}} .Status | toUpper {{"}}"}} |
            | **Severity** | üî¥ **CRITICAL** |
            | **Cluster** | {{"{{"}} .CommonLabels.cluster {{"}}"}} |
            | **Namespace** | {{"{{"}} .CommonLabels.namespace {{"}}"}} |
            | **Alerts Count** | {{"{{"}} len .Alerts {{"}}"}} |

            ---
            {{"{{"}} range .Alerts {{"}}"}}
            **‚ö†Ô∏è {{"{{"}} .Annotations.summary {{"}}"}}**

            {{"{{"}} .Annotations.description {{"}}"}}

            {{"{{"}} if .Annotations.runbook_url {{"}}"}}**üìñ Runbook:** [View Runbook]({{"{{"}} .Annotations.runbook_url {{"}}"}}){{"{{"}} end {{"}}"}}

            **Affected Resources:**
            {{"{{"}} if .Labels.pod {{"}}"}}- **Pod:** {{"{{"}} .Labels.pod {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.container {{"}}"}}- **Container:** {{"{{"}} .Labels.container {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.service {{"}}"}}- **Service:** {{"{{"}} .Labels.service {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.node {{"}}"}}- **Node:** {{"{{"}} .Labels.node {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.deployment {{"}}"}}- **Deployment:** {{"{{"}} .Labels.deployment {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.statefulset {{"}}"}}- **StatefulSet:** {{"{{"}} .Labels.statefulset {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.daemonset {{"}}"}}- **DaemonSet:** {{"{{"}} .Labels.daemonset {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.job {{"}}"}}- **Job:** {{"{{"}} .Labels.job {{"}}"}}{{"{{"}} end {{"}}"}}
            {{"{{"}} if .Labels.instance {{"}}"}}- **Instance:** {{"{{"}} .Labels.instance {{"}}"}}{{"{{"}} end {{"}}"}}

            **Timeline:**
            - **Started:** {{"{{"}} .StartsAt.Format "2006-01-02 15:04:05 UTC" {{"}}"}}
            {{"{{"}} if .EndsAt {{"}}"}}- **Ended:** {{"{{"}} .EndsAt.Format "2006-01-02 15:04:05 UTC" {{"}}"}}{{"{{"}} end {{"}}"}}

            ---
            {{"{{"}} end {{"}}"}}
            **üîó Quick Links**
            [üìà Grafana](https://grafana.ops.techsecom.io) | [üîî Alertmanager](https://alertmanager.ops.techsecom.io) | [üìä Prometheus](https://prometheus.ops.techsecom.io)

            {{"{{"}} if eq .Status "firing" {{"}}"}}
            **üí° Suggested Actions:**
            1. Check the affected resource status in the cluster
            2. Review recent changes or deployments
            3. Check resource utilization and logs
            4. Escalate if unable to resolve within SLA
            {{"{{"}} end {{"}}"}}
