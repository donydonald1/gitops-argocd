apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: msteams-config
  labels:
    app: alertmanager
spec:
  route:
    groupBy: ['alertname', 'job', 'namespace']
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 4h
    receiver: msteams
    routes:
      - receiver: "null"
        matchers:
          - matchType: "=~"
            name: alertname
            value: "Watchdog|InfoInhibitor"
      - receiver: msteams-critical
        matchers:
          - matchType: "="
            name: severity
            value: critical
        groupWait: 10s
        groupInterval: 1m
        repeatInterval: 1h
        continue: false
      - receiver: msteams
        matchers:
          - matchType: "="
            name: severity
            value: warning
        groupWait: 30s
        groupInterval: 5m
        repeatInterval: 4h
      - receiver: msteams
  inhibitRules:
    - sourceMatch:
        - matchType: "="
          name: severity
          value: critical
      targetMatch:
        - matchType: "="
          name: severity
          value: warning
      equal: ["alertname", "namespace"]
  receivers:
    - name: "null"
    - name: msteams
      msteamsConfigs:
        - sendResolved: true
          webhookUrl:
            name: alertmanager-msteams-secret
            key: webhook-url
          title: {{ printf "%s" `'[{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}'` }}
          text: {{ printf "%s" `'**Cluster**: {{ .CommonLabels.cluster }} | **Severity**: {{ .CommonLabels.severity }}

{{ range .Alerts }}**{{ .Annotations.summary }}**
{{ .Annotations.description }}
{{ end }}

[Grafana](https://grafana.ops.techsecom.io) | [Alertmanager](https://alertmanager.ops.techsecom.io)'` }}
    - name: msteams-critical
      msteamsConfigs:
        - sendResolved: true
          webhookUrl:
            name: alertmanager-msteams-secret
            key: webhook-url
          title: {{ printf "%s" `'ðŸš¨ CRITICAL: {{ .CommonLabels.alertname }}'` }}
          text: {{ printf "%s" `'**CRITICAL ALERT**

**Cluster**: {{ .CommonLabels.cluster }}
{{ range .Alerts }}**{{ .Annotations.summary }}**
{{ .Annotations.description }}
{{ end }}

[Grafana](https://grafana.ops.techsecom.io)'` }}
