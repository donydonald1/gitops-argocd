{{- if .Values.ilm.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-elasticsearch-ilm-setup
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: elasticsearch-ilm-setup
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    # ArgoCD sync wave - run after Elasticsearch and Kibana are deployed
    argocd.argoproj.io/sync-wave: "10"
    # ArgoCD hook - run as a post-sync hook
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 10
  template:
    metadata:
      labels:
        app.kubernetes.io/name: elasticsearch-ilm-setup
    spec:
      restartPolicy: OnFailure
      containers:
      - name: ilm-setup
        image: {{ .Values.ilm.image | default "curlimages/curl:latest" }}
        command: ["sh", "-c"]
        args:
        - |
          set -e

          ES_URL="https://{{ .Values.ilm.elasticsearch.serviceName }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.ilm.elasticsearch.port }}"
          KIBANA_URL="https://{{ .Values.ilm.kibana.serviceName }}.{{ .Release.Namespace }}.svc.cluster.local:{{ .Values.ilm.kibana.port }}"

          echo "=== Waiting for Elasticsearch to be ready ==="
          until curl --silent --insecure --user "$ES_USER:$ES_PASSWORD" --fail "$ES_URL/_cluster/health?wait_for_status=yellow&timeout=60s"; do
            echo "Waiting for Elasticsearch cluster to be ready..."
            sleep 10
          done
          echo ""
          echo "Elasticsearch is ready!"

          echo "=== Waiting for Kibana to be ready ==="
          until curl --silent --insecure --user "$ES_USER:$ES_PASSWORD" --fail "$KIBANA_URL/api/status" | grep -q '"overall":{"level":"available"'; do
            echo "Waiting for Kibana to be ready..."
            sleep 10
          done
          echo ""
          echo "Kibana is ready!"

          #######################################
          # ILM Policy for Audit Logs
          # Uses data tier routing (data_warm, data_cold) instead of box_type
          # This is the recommended approach for Elasticsearch 8.x
          #######################################
          echo ""
          echo "=== Creating ILM Policy: {{ .Values.ilm.policies.auditLogs.name }} ==="
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/_ilm/policy/{{ .Values.ilm.policies.auditLogs.name }}" \
            -H 'Content-Type: application/json' -d '
          {
            "policy": {
              "phases": {
                "hot": {
                  "min_age": "0ms",
                  "actions": {
                    "rollover": {
                      "max_age": "{{ .Values.ilm.policies.auditLogs.hot.rollover.maxAge }}",
                      "max_primary_shard_size": "{{ .Values.ilm.policies.auditLogs.hot.rollover.maxPrimaryShardSize }}",
                      "max_docs": {{ .Values.ilm.policies.auditLogs.hot.rollover.maxDocs }}
                    },
                    "set_priority": {
                      "priority": 100
                    }
                  }
                },
                "warm": {
                  "min_age": "{{ .Values.ilm.policies.auditLogs.warm.minAge }}",
                  "actions": {
                    "migrate": {
                      "enabled": true
                    },
                    "allocate": {
                      "number_of_replicas": {{ .Values.ilm.policies.auditLogs.warm.replicas }}
                    },
                    "forcemerge": {
                      "max_num_segments": 1
                    },
                    "shrink": {
                      "number_of_shards": 1
                    },
                    "set_priority": {
                      "priority": 50
                    }
                  }
                },
                "cold": {
                  "min_age": "{{ .Values.ilm.policies.auditLogs.cold.minAge }}",
                  "actions": {
                    "migrate": {
                      "enabled": true
                    },
                    "allocate": {
                      "number_of_replicas": {{ .Values.ilm.policies.auditLogs.cold.replicas }}
                    },
                    "set_priority": {
                      "priority": 0
                    },
                    "readonly": {}
                  }
                },
                "delete": {
                  "min_age": "{{ .Values.ilm.policies.auditLogs.delete.minAge }}",
                  "actions": {
                    "wait_for_snapshot": {
                      "policy": "{{ .Values.ilm.policies.auditLogs.delete.waitForSnapshot | default "none" }}"
                    },
                    "delete": {
                      "delete_searchable_snapshot": true
                    }
                  }
                }
              }
            }
          }'
          echo ""
          echo "ILM Policy {{ .Values.ilm.policies.auditLogs.name }} created successfully"

          #######################################
          # ILM Policy for Container Logs
          # Uses data tier routing (data_warm, data_cold) instead of box_type
          # This is the recommended approach for Elasticsearch 8.x
          #######################################
          echo ""
          echo "=== Creating ILM Policy: {{ .Values.ilm.policies.containerLogs.name }} ==="
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/_ilm/policy/{{ .Values.ilm.policies.containerLogs.name }}" \
            -H 'Content-Type: application/json' -d '
          {
            "policy": {
              "phases": {
                "hot": {
                  "min_age": "0ms",
                  "actions": {
                    "rollover": {
                      "max_age": "{{ .Values.ilm.policies.containerLogs.hot.rollover.maxAge }}",
                      "max_primary_shard_size": "{{ .Values.ilm.policies.containerLogs.hot.rollover.maxPrimaryShardSize }}",
                      "max_docs": {{ .Values.ilm.policies.containerLogs.hot.rollover.maxDocs }}
                    },
                    "set_priority": {
                      "priority": 100
                    }
                  }
                },
                "warm": {
                  "min_age": "{{ .Values.ilm.policies.containerLogs.warm.minAge }}",
                  "actions": {
                    "migrate": {
                      "enabled": true
                    },
                    "allocate": {
                      "number_of_replicas": {{ .Values.ilm.policies.containerLogs.warm.replicas }}
                    },
                    "forcemerge": {
                      "max_num_segments": 1
                    },
                    "shrink": {
                      "number_of_shards": 1
                    },
                    "set_priority": {
                      "priority": 50
                    }
                  }
                },
                "cold": {
                  "min_age": "{{ .Values.ilm.policies.containerLogs.cold.minAge }}",
                  "actions": {
                    "migrate": {
                      "enabled": true
                    },
                    "allocate": {
                      "number_of_replicas": {{ .Values.ilm.policies.containerLogs.cold.replicas }}
                    },
                    "set_priority": {
                      "priority": 0
                    },
                    "readonly": {}
                  }
                },
                "delete": {
                  "min_age": "{{ .Values.ilm.policies.containerLogs.delete.minAge }}",
                  "actions": {
                    "wait_for_snapshot": {
                      "policy": "{{ .Values.ilm.policies.containerLogs.delete.waitForSnapshot | default "none" }}"
                    },
                    "delete": {
                      "delete_searchable_snapshot": true
                    }
                  }
                }
              }
            }
          }'
          echo ""
          echo "ILM Policy {{ .Values.ilm.policies.containerLogs.name }} created successfully"

          #######################################
          # Index Template for Audit Logs
          # Uses data tier routing (data_hot) instead of box_type attribute
          #######################################
          echo ""
          echo "=== Creating Index Template: audit-logs-template ==="
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/_index_template/audit-logs-template" \
            -H 'Content-Type: application/json' -d '
          {
            "index_patterns": ["audit-logs-*"],
            "priority": 200,
            "template": {
              "settings": {
                "index.routing.allocation.include._tier_preference": "data_hot",
                "index.number_of_replicas": {{ .Values.ilm.indexTemplates.auditLogs.replicas }},
                "index.number_of_shards": {{ .Values.ilm.indexTemplates.auditLogs.shards }},
                "index.lifecycle.name": "{{ .Values.ilm.policies.auditLogs.name }}",
                "index.lifecycle.rollover_alias": "audit-logs",
                "index.refresh_interval": "{{ .Values.ilm.indexTemplates.auditLogs.refreshInterval | default "5s" }}"
              },
              "mappings": {
                "_source": {
                  "enabled": true
                },
                "properties": {
                  "@timestamp": {
                    "type": "date"
                  }
                }
              }
            }
          }'
          echo ""
          echo "Index Template audit-logs-template created successfully"

          #######################################
          # Index Template for Container Logs
          # Uses data tier routing (data_hot) instead of box_type attribute
          #######################################
          echo ""
          echo "=== Creating Index Template: container-logs-template ==="
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/_index_template/container-logs-template" \
            -H 'Content-Type: application/json' -d '
          {
            "index_patterns": ["container-logs-*"],
            "priority": 200,
            "template": {
              "settings": {
                "index.routing.allocation.include._tier_preference": "data_hot",
                "index.number_of_replicas": {{ .Values.ilm.indexTemplates.containerLogs.replicas }},
                "index.number_of_shards": {{ .Values.ilm.indexTemplates.containerLogs.shards }},
                "index.lifecycle.name": "{{ .Values.ilm.policies.containerLogs.name }}",
                "index.lifecycle.rollover_alias": "container-logs",
                "index.refresh_interval": "{{ .Values.ilm.indexTemplates.containerLogs.refreshInterval | default "5s" }}"
              },
              "mappings": {
                "_source": {
                  "enabled": true
                },
                "properties": {
                  "@timestamp": {
                    "type": "date"
                  }
                }
              }
            }
          }'
          echo ""
          echo "Index Template container-logs-template created successfully"

          #######################################
          # Bootstrap Initial Indices with Aliases
          #######################################
          echo ""
          echo "=== Bootstrapping initial index: audit-logs-000001 ==="
          # Check if index already exists
          if curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" --fail "$ES_URL/audit-logs-000001" > /dev/null 2>&1; then
            echo "Index audit-logs-000001 already exists, skipping creation"
          else
            curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/audit-logs-000001" \
              -H 'Content-Type: application/json' -d '
            {
              "aliases": {
                "audit-logs": {
                  "is_write_index": true
                }
              }
            }'
            echo ""
            echo "Index audit-logs-000001 created with write alias"
          fi

          echo ""
          echo "=== Bootstrapping initial index: container-logs-000001 ==="
          # Check if index already exists
          if curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" --fail "$ES_URL/container-logs-000001" > /dev/null 2>&1; then
            echo "Index container-logs-000001 already exists, skipping creation"
          else
            curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/container-logs-000001" \
              -H 'Content-Type: application/json' -d '
            {
              "aliases": {
                "container-logs": {
                  "is_write_index": true
                }
              }
            }'
            echo ""
            echo "Index container-logs-000001 created with write alias"
          fi

          #######################################
          # Create Kibana Data Views
          #######################################
          echo ""
          echo "=== Creating Kibana Data Views ==="

          # Create Audit Logs Data View
          curl --silent --insecure --user "$ES_USER:$ES_PASSWORD" -X POST "$KIBANA_URL/api/data_views/data_view" \
            -H "kbn-xsrf: true" \
            -H 'Content-Type: application/json' -d '
          {
            "data_view": {
              "title": "audit-logs*",
              "name": "Audit Logs",
              "timeFieldName": "@timestamp"
            },
            "override": true
          }' || echo "Data view may already exist"
          echo ""

          # Create Container Logs Data View
          curl --silent --insecure --user "$ES_USER:$ES_PASSWORD" -X POST "$KIBANA_URL/api/data_views/data_view" \
            -H "kbn-xsrf: true" \
            -H 'Content-Type: application/json' -d '
          {
            "data_view": {
              "title": "container-logs*",
              "name": "Container Logs",
              "timeFieldName": "@timestamp"
            },
            "override": true
          }' || echo "Data view may already exist"
          echo ""

          {{- if .Values.kibana.spaces.enabled }}
          #######################################
          # Create Kibana Spaces
          #######################################
          echo ""
          echo "=== Creating Kibana Spaces ==="
          {{- range .Values.kibana.spaces.list }}

          echo "Creating space: {{ .id }}"
          curl --silent --insecure --user "$ES_USER:$ES_PASSWORD" -X POST "$KIBANA_URL/api/spaces/space" \
            -H "kbn-xsrf: true" \
            -H 'Content-Type: application/json' -d '
          {
            "id": "{{ .id }}",
            "name": "{{ .name }}",
            "description": "{{ .description | default "" }}",
            "disabledFeatures": {{ .disabledFeatures | default list | toJson }}
          }' 2>/dev/null || echo "Space {{ .id }} may already exist"
          echo ""
          {{- end }}
          {{- end }}

          {{- if .Values.kibana.roles.enabled }}
          #######################################
          # Create Elasticsearch Roles
          #######################################
          echo ""
          echo "=== Creating Elasticsearch Roles ==="
          {{- range .Values.kibana.roles.list }}

          echo "Creating role: {{ .name }}"
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/_security/role/{{ .name }}" \
            -H 'Content-Type: application/json' -d '{{ .definition | toJson }}'
          echo ""
          {{- end }}
          {{- end }}

          {{- if .Values.kibana.roleMappings.enabled }}
          #######################################
          # Create Role Mappings
          #######################################
          echo ""
          echo "=== Creating Role Mappings ==="
          {{- range .Values.kibana.roleMappings.list }}

          echo "Creating role mapping: {{ .name }}"
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/_security/role_mapping/{{ .name }}" \
            -H 'Content-Type: application/json' -d '{{ .definition | toJson }}'
          echo ""
          {{- end }}
          {{- end }}

          {{- if .Values.snapshots.enabled }}
          #######################################
          # Register S3/MinIO Snapshot Repository
          #######################################
          echo ""
          echo "=== Registering S3 Snapshot Repository ==="

          # First, add S3 credentials to keystore (requires restart, so we use repository settings instead)
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/_snapshot/s3-repository" \
            -H 'Content-Type: application/json' -d '
          {
            "type": "s3",
            "settings": {
              "bucket": "{{ .Values.snapshots.s3.bucket }}",
              "endpoint": "{{ .Values.snapshots.s3.endpoint }}",
              "base_path": "{{ .Values.snapshots.s3.basePath }}",
              "protocol": "http",
              "path_style_access": true
            }
          }'
          echo ""
          echo "S3 Snapshot Repository registered"

          #######################################
          # Create Snapshot Lifecycle Management (SLM) Policy
          # partial=true allows snapshots to succeed even with unassigned shards
          # This prevents delete phase from being blocked during node failures
          #######################################
          echo ""
          echo "=== Creating SLM Policy: {{ .Values.snapshots.slm.name }} ==="
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X PUT "$ES_URL/_slm/policy/{{ .Values.snapshots.slm.name }}" \
            -H 'Content-Type: application/json' -d '
          {
            "schedule": "{{ .Values.snapshots.slm.schedule }}",
            "name": "<logs-snap-{now/d}>",
            "repository": "s3-repository",
            "config": {
              "indices": ["audit-logs-*", "container-logs-*"],
              "ignore_unavailable": true,
              "include_global_state": false,
              "partial": true
            },
            "retention": {
              "expire_after": "{{ .Values.snapshots.slm.retention.expireAfter }}",
              "min_count": {{ .Values.snapshots.slm.retention.minCount }},
              "max_count": {{ .Values.snapshots.slm.retention.maxCount }}
            }
          }'
          echo ""
          echo "SLM Policy {{ .Values.snapshots.slm.name }} created"

          # Execute initial snapshot
          echo ""
          echo "=== Executing initial snapshot ==="
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" -X POST "$ES_URL/_slm/policy/{{ .Values.snapshots.slm.name }}/_execute"
          echo ""
          {{- end }}

          #######################################
          # Verify ILM Policies
          #######################################
          echo ""
          echo "=== Verifying ILM Policies ==="
          echo "Audit Logs ILM Policy:"
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" "$ES_URL/_ilm/policy/{{ .Values.ilm.policies.auditLogs.name }}" | head -c 500
          echo ""
          echo ""
          echo "Container Logs ILM Policy:"
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" "$ES_URL/_ilm/policy/{{ .Values.ilm.policies.containerLogs.name }}" | head -c 500
          echo ""

          #######################################
          # Verify Index Lifecycle Status
          #######################################
          echo ""
          echo "=== Checking Index Lifecycle Status ==="
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" "$ES_URL/audit-logs-*/_ilm/explain" | head -c 1000
          echo ""
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" "$ES_URL/container-logs-*/_ilm/explain" | head -c 1000
          echo ""

          {{- if .Values.snapshots.enabled }}
          #######################################
          # Verify Snapshot Repository
          #######################################
          echo ""
          echo "=== Verifying Snapshot Repository ==="
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" "$ES_URL/_snapshot/s3-repository"
          echo ""
          echo ""
          echo "=== SLM Policy Status ==="
          curl --silent --insecure -u "$ES_USER:$ES_PASSWORD" "$ES_URL/_slm/policy/{{ .Values.snapshots.slm.name }}"
          echo ""
          {{- end }}

          echo ""
          echo "=== ILM Setup Complete ==="
          echo "Audit logs retention: {{ .Values.ilm.policies.auditLogs.delete.minAge }}"
          echo "Container logs retention: {{ .Values.ilm.policies.containerLogs.delete.minAge }}"
          {{- if .Values.snapshots.enabled }}
          echo "Snapshots: Enabled (to S3/MinIO bucket: {{ .Values.snapshots.s3.bucket }})"
          echo "SLM Schedule: {{ .Values.snapshots.slm.schedule }}"
          echo "Snapshot Retention: {{ .Values.snapshots.slm.retention.expireAfter }}"
          {{- end }}
          echo ""
          echo "Lifecycle phases:"
          echo "  Hot -> Warm: audit={{ .Values.ilm.policies.auditLogs.warm.minAge }}, container={{ .Values.ilm.policies.containerLogs.warm.minAge }}"
          echo "  Warm -> Cold: audit={{ .Values.ilm.policies.auditLogs.cold.minAge }}, container={{ .Values.ilm.policies.containerLogs.cold.minAge }}"
          echo "  Cold -> Delete: audit={{ .Values.ilm.policies.auditLogs.delete.minAge }}, container={{ .Values.ilm.policies.containerLogs.delete.minAge }}"
          {{- if .Values.snapshots.enabled }}
          echo "  Wait for snapshot before delete: {{ .Values.ilm.policies.auditLogs.delete.waitForSnapshot }}"
          {{- end }}

        env:
        - name: ES_USER
          value: "elastic"
        - name: ES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.ilm.elasticsearch.secretName }}
              key: {{ .Values.ilm.elasticsearch.secretKey }}
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
{{- end }}
