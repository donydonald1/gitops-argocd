apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: alertmanager-rancher-monitoring-alertmanager
  labels:
    app: rancher-monitoring-alertmanager
    app.kubernetes.io/instance: monitoring-stack
    app.kubernetes.io/part-of: rancher-monitoring
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault
  target:
    name: alertmanager-rancher-monitoring-alertmanager
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        alertmanager.yaml: |
          global:
            resolve_timeout: 5m
          inhibit_rules:
          - equal:
            - alertname
            - namespace
            source_matchers:
            - severity = "critical"
            target_matchers:
            - severity = "warning"
          - equal:
            - prometheus
            source_match:
              alertname: Watchdog
            target_match_re:
              alertname: .+Overcommit
          receivers:
          - name: "null"
          - name: msteams
            msteams_configs:
            - send_resolved: true
              webhook_url: '{{ "{{" }} .webhook_url {{ "}}" }}'
              title: '{{ `{{ if eq .Status "firing" }}` }}ðŸ”´{{ `{{ else }}` }}ðŸŸ¢{{ `{{ end }}` }} [{{ `{{ .Status | upper }}` }}{{ `{{ if eq .Status "firing" }}` }}:{{ `{{ .Alerts.Firing | len }}` }}{{ `{{ end }}` }}] {{ `{{ .CommonLabels.alertname }}` }}'
              text: |
                {{ `{{ if eq .Status "firing" }}` }}
                âš ï¸ **ALERT FIRING** - Immediate attention required
                {{ `{{ else }}` }}
                âœ… **ALERT RESOLVED** - Issue has been remediated
                {{ `{{ end }}` }}

                ---

                **Alert Information**

                | Field | Value |
                |-------|-------|
                | **Cluster** | {{ "`{{ .CommonLabels.cluster }}`" }} |
                | **Alert** | {{ "`{{ .CommonLabels.alertname }}`" }} |
                | **Severity** | {{ `{{ if eq .CommonLabels.severity "critical" }}` }}ðŸ”´ CRITICAL{{ `{{ else if eq .CommonLabels.severity "warning" }}` }}ðŸŸ¡ WARNING{{ `{{ else }}` }}{{ `{{ .CommonLabels.severity }}` }}{{ `{{ end }}` }} |
                {{ `{{ if .CommonLabels.namespace }}` }}| **Namespace** | {{ "`{{ .CommonLabels.namespace }}`" }} |{{ `{{ end }}` }}
                {{ `{{ if .CommonLabels.service }}` }}| **Service** | {{ "`{{ .CommonLabels.service }}`" }} |{{ `{{ end }}` }}

                ---

                {{ `{{ range $alert := .Alerts }}` }}

                **Alert Details**

                {{ `{{ if $alert.Annotations.summary }}` }}
                > **Summary**: {{ `{{ $alert.Annotations.summary }}` }}
                {{ `{{ end }}` }}

                {{ `{{ if $alert.Annotations.description }}` }}
                > **Description**: {{ `{{ $alert.Annotations.description }}` }}
                {{ `{{ end }}` }}

                {{ `{{ if $alert.Annotations.runbook_url }}` }}
                **Runbook**: {{ `{{ $alert.Annotations.runbook_url }}` }}
                {{ `{{ end }}` }}

                **Labels:**
                {{ `{{ if $alert.Labels.pod }}` }}- Pod: {{ `{{ $alert.Labels.pod }}` }}{{ `{{ end }}` }}
                {{ `{{ if $alert.Labels.container }}` }}- Container: {{ `{{ $alert.Labels.container }}` }}{{ `{{ end }}` }}
                {{ `{{ if $alert.Labels.instance }}` }}- Instance: {{ `{{ $alert.Labels.instance }}` }}{{ `{{ end }}` }}
                {{ `{{ if $alert.Labels.node }}` }}- Node: {{ `{{ $alert.Labels.node }}` }}{{ `{{ end }}` }}
                {{ `{{ if $alert.Labels.job }}` }}- Job: {{ `{{ $alert.Labels.job }}` }}{{ `{{ end }}` }}

                ---

                {{ `{{ end }}` }}

                **Quick Links**

                - Grafana: https://grafana.ops.techsecom.io
                - Alertmanager: https://alertmanager.ops.techsecom.io
                - Prometheus: https://prometheus.ops.techsecom.io

          - name: msteams-critical
            msteams_configs:
            - send_resolved: true
              webhook_url: '{{ "{{" }} .webhook_url {{ "}}" }}'
              title: 'CRITICAL: {{ `{{ .CommonLabels.alertname }}` }} on {{ `{{ .CommonLabels.cluster }}` }}'
              text: |
                **CRITICAL ALERT - IMMEDIATE ACTION REQUIRED**

                ---

                | Field | Value |
                |-------|-------|
                | **Cluster** | {{ "`{{ .CommonLabels.cluster }}`" }} |
                | **Alert** | {{ "`{{ .CommonLabels.alertname }}`" }} |
                | **Severity** | CRITICAL |
                {{ `{{ if .CommonLabels.namespace }}` }}| **Namespace** | {{ "`{{ .CommonLabels.namespace }}`" }} |{{ `{{ end }}` }}
                {{ `{{ if .CommonLabels.pod }}` }}| **Pod** | {{ "`{{ .CommonLabels.pod }}`" }} |{{ `{{ end }}` }}
                {{ `{{ if .CommonLabels.node }}` }}| **Node** | {{ "`{{ .CommonLabels.node }}`" }} |{{ `{{ end }}` }}

                ---

                {{ `{{ range $alert := .Alerts }}` }}
                {{ `{{ if $alert.Annotations.summary }}` }}{{ `{{ $alert.Annotations.summary }}` }}{{ `{{ end }}` }}

                {{ `{{ if $alert.Annotations.description }}` }}Details: {{ `{{ $alert.Annotations.description }}` }}{{ `{{ end }}` }}
                {{ `{{ end }}` }}

                ---

                **Immediate Actions:**
                1. STOP - Acknowledge this alert
                2. ASSESS - Check Grafana for impact
                3. ACT - Follow runbook or escalate immediately
                4. COMMUNICATE - Update stakeholders

          route:
            group_by:
            - alertname
            - job
            - namespace
            group_interval: 5m
            group_wait: 30s
            receiver: msteams
            repeat_interval: 4h
            routes:
            - matchers:
              - alertname =~ "Watchdog|InfoInhibitor"
              receiver: "null"
            - continue: false
              group_interval: 1m
              group_wait: 10s
              matchers:
              - severity = "critical"
              receiver: msteams-critical
              repeat_interval: 1h
            - group_interval: 5m
              group_wait: 30s
              matchers:
              - severity = "warning"
              receiver: msteams
              repeat_interval: 4h
            - receiver: msteams
          templates: []
  data:
    - secretKey: webhook_url
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: None
        key: secret/msteams
        property: webhook-url
