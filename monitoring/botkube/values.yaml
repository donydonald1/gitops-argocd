botkube:
  # Cluster settings
  settings:
    clusterName: ops-dc-tx-pl-hq-prd
    configWatcher: true
    upgradeNotifier: true
    log:
      level: debug
      disableColors: false

  # Plugin Manager Configuration
  # Using cluster-local plugins server to avoid GitHub timeout
  plugins:
    cacheDir: /tmp/plugins
    healthCheckInterval: 30s
    incomingWebhook:
      enabled: false
    restartPolicy:
      type: DeactivatePlugin
      threshold: 10
    # Plugin repositories - use local service to avoid GitHub timeout
    repositories:
      botkube:
        url: http://botkube-plugins-server.botkube.svc.cluster.local/plugins-index.yaml

  # Extra volumes for plugin cache
  extraVolumes:
    - name: plugins-cache
      emptyDir: {}

  # Mount plugin cache in main container
  extraVolumeMounts:
    - name: plugins-cache
      mountPath: /tmp/plugins

  # Extra objects to create - plugins server using ConfigMap
  # The ConfigMap 'botkube-plugins-index' contains the pre-downloaded plugins-index.yaml
  # This bypasses botkube's 30s HTTP timeout by serving from local nginx
  extraObjects:
    # Plugins server deployment - serves ConfigMap via nginx
    - apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: botkube-plugins-server
        namespace: '{{ .Release.Namespace }}'
        labels:
          app: botkube-plugins-server
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: botkube-plugins-server
        template:
          metadata:
            labels:
              app: botkube-plugins-server
          spec:
            containers:
              - name: nginx
                image: nginx:1.25-alpine
                ports:
                  - containerPort: 80
                volumeMounts:
                  - name: plugins-index
                    mountPath: /usr/share/nginx/html/plugins-index.yaml
                    subPath: plugins-index.yaml
                    readOnly: true
                resources:
                  requests:
                    cpu: 10m
                    memory: 16Mi
                  limits:
                    cpu: 50m
                    memory: 32Mi
                livenessProbe:
                  httpGet:
                    path: /plugins-index.yaml
                    port: 80
                  initialDelaySeconds: 5
                  periodSeconds: 30
                readinessProbe:
                  httpGet:
                    path: /plugins-index.yaml
                    port: 80
                  initialDelaySeconds: 2
                  periodSeconds: 5
            volumes:
              - name: plugins-index
                configMap:
                  name: botkube-plugins-index
    # Plugins server service
    - apiVersion: v1
      kind: Service
      metadata:
        name: botkube-plugins-server
        namespace: '{{ .Release.Namespace }}'
      spec:
        selector:
          app: botkube-plugins-server
        ports:
          - port: 80
            targetPort: 80

  # Disable analytics
  analytics:
    disable: true

  # NOTE: Slack Socket Mode tokens must be provided directly in the config.
  # The env var override mechanism (BOTKUBE_COMMUNICATIONS__*) does NOT work
  # for Slack credentials. For production, use ArgoCD Vault Plugin (AVP) to
  # inject secrets into values at sync time.
  #
  # The tokens are stored in Vault at: secret/botkube
  # Keys: slackBotToken, slackAppToken

  # Ingress configuration
  ingress:
    create: true
    host: "kubebot.ops.techsecom.io"
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    tls:
      enabled: true
      secretName: "botkube-tls"

  # Communication platforms configuration
  # For production: Use ArgoCD Vault Plugin (AVP) to inject real tokens
  # Example with AVP: botToken: <path:secret/data/botkube#slackBotToken>
  communications:
    default-group:
      socketSlack:
        enabled: true
        # IMPORTANT: Replace these with real tokens or use AVP for production
        botToken: "<path:secret/data/botkube#slackBotToken>"
        appToken: "<path:secret/data/botkube#slackAppToken>"
        channels:
          # Main alerts channel - read-only access for all users
          default:
            name: kubebot-alerts
            bindings:
              executors:
                - kubectl-read-only
              sources:
                - k8s-errors           # Errors and warnings
                - k8s-critical         # Deletions of important resources
                - k8s-nodes            # Node status changes
                - prometheus-alerts    # Prometheus firing alerts
                - k8s-recommendations  # Best practice recommendations
                - argocd-notifications # ArgoCD sync and health status

          # Admin channel - full access for operations team
          admin:
            name: kubebot-admin
            bindings:
              executors:
                - kubectl-full-access
                - helm-executor
              sources:
                - k8s-errors
                - k8s-critical
                - k8s-nodes
                - prometheus-alerts
                - crds
                - argocd-notifications

  # Service monitor for Prometheus
  serviceMonitor:
    enabled: true
    labels:
      release: kube-prometheus-stack

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Pod security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000

  # Extra environment variables for extended timeouts
  extraEnv:
    - name: BOTKUBE_PLUGINS_STARTUP_TIMEOUT
      value: "10m"
    # HTTP client timeouts for plugin downloads
    - name: BOTKUBE_PLUGINS_REPOSITORIES__BOTKUBE__HTTP_CLIENT__TIMEOUT
      value: "5m"
    - name: BOTKUBE_PLUGINS_HTTP_TIMEOUT
      value: "300"
    - name: HTTP_TIMEOUT
      value: "300"
    # Go HTTP client timeout
    - name: GODEBUG
      value: "http2client=0"

  # Startup probe - give more time for plugin download
  # Plugin download from GitHub can take several minutes
  startupProbe:
    enabled: true
    initialDelaySeconds: 120  # Wait 2 minutes before first check
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 30  # 120 + (30*30) = 1020 seconds max startup time (~17 min)

  # Liveness probe - only after startup succeeds
  livenessProbe:
    enabled: true
    initialDelaySeconds: 60
    periodSeconds: 60
    timeoutSeconds: 10
    failureThreshold: 5

  # Readiness probe
  readinessProbe:
    enabled: true
    initialDelaySeconds: 60
    periodSeconds: 15
    timeoutSeconds: 10
    failureThreshold: 10

  # Executors configuration
  executors:
    # Read-only kubectl access
    kubectl-read-only:
      botkube/kubectl:
        enabled: true
        config:
          defaultNamespace: default
          interactiveBuilder:
            allowed:
              namespaces:
                - ".*"
                - "default"
              verbs:
                - get
                - list
                - describe
                - logs
                - top
              resources:
                - pods
                - services
                - deployments
                - statefulsets
                - daemonsets
                - jobs
                - cronjobs
                - configmaps
                - nodes
                - namespaces
                - events
                - ingresses
                - persistentvolumeclaims
                - persistentvolumes
        # RBAC context - required for kubectl plugin to work
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

    # Full kubectl access (restricted to admins)
    kubectl-full-access:
      botkube/kubectl:
        enabled: true
        config:
          defaultNamespace: default
          interactiveBuilder:
            allowed:
              namespaces:
                - ".*"
                - "default"
              verbs:
                - get
                - list
                - describe
                - logs
                - top
                - delete
                - rollout
                - scale
                - exec
              resources:
                - pods
                - services
                - deployments
                - statefulsets
                - daemonsets
                - jobs
                - cronjobs
                - configmaps
                - secrets
                - nodes
                - namespaces
                - events
                - ingresses
                - persistentvolumeclaims
        # RBAC context - required for kubectl plugin to work
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

    # Helm executor for managing releases from Slack
    helm-executor:
      botkube/helm:
        enabled: true
        config:
          helmDriver: secret
          helmCacheDir: /tmp/helm/.cache
          helmConfigDir: /tmp/helm/
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

  # Actions configuration
  actions:
    # Disabled - was using k8s-events which is too noisy
    # describe-created-resource:
    #   enabled: true
    #   displayName: "Describe created resource"
    #   command: "kubectl describe {{ .Event.Kind }}/{{ .Event.Name }} -n {{ .Event.Namespace }}"
    #   bindings:
    #     sources:
    #       - k8s-events
    #     executors:
    #       - kubectl-read-only

    show-logs-on-error:
      enabled: true
      displayName: "Show logs on error"
      command: "kubectl logs {{ .Event.Kind }}/{{ .Event.Name }} -n {{ .Event.Namespace }} --tail=100"
      bindings:
        sources:
          - k8s-errors
        executors:
          - kubectl-read-only

    # Describe ArgoCD application on status change
    describe-argocd-app:
      enabled: true
      displayName: "Describe ArgoCD Application"
      command: "kubectl describe application {{ .Event.Name }} -n {{ .Event.Namespace }}"
      bindings:
        sources:
          - argocd-notifications
        executors:
          - kubectl-read-only

    # Get ArgoCD app sync status
    get-argocd-status:
      enabled: true
      displayName: "Get ArgoCD Sync Status"
      command: "kubectl get application {{ .Event.Name }} -n {{ .Event.Namespace }} -o jsonpath='{.status.sync.status} - {.status.health.status}'"
      bindings:
        sources:
          - argocd-notifications
        executors:
          - kubectl-read-only

  # Sources configuration
  sources:
    # Critical events only - node issues and resource deletions
    k8s-critical:
      displayName: "Critical Kubernetes Events"
      botkube/kubernetes:
        enabled: true
        config:
          namespaces:
            include:
              - ".*"
            exclude:
              - kube-system
              - cattle-system
              - cattle-fleet-system
              - cattle-impersonation-system
          event:
            types:
              - delete  # Only deletions (accidental deletes, scaling down)
          resources:
            - type: apps/v1/deployments
            - type: apps/v1/statefulsets
            - type: v1/namespaces
            - type: v1/persistentvolumeclaims
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

    # Node status changes (critical for cluster health)
    k8s-nodes:
      displayName: "Node Events"
      botkube/kubernetes:
        enabled: true
        config:
          event:
            types:
              - create
              - delete
              - error
          resources:
            - type: v1/nodes
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

    # Error events
    k8s-errors:
      displayName: "Kubernetes Errors"
      botkube/kubernetes:
        enabled: true
        config:
          namespaces:
            include:
              - ".*"
          event:
            types:
              - error
              - warning
          resources:
            - type: v1/pods
            - type: v1/nodes
            - type: apps/v1/deployments
            - type: apps/v1/statefulsets
            - type: apps/v1/daemonsets
            - type: batch/v1/jobs
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

    # Recommendation events
    k8s-recommendations:
      displayName: "Kubernetes Recommendations"
      botkube/kubernetes:
        enabled: true
        config:
          namespaces:
            include:
              - ".*"
          recommendations:
            pod:
              noLatestImageTag: true
              labelsSet: true
            ingress:
              backendServiceValid: true
              tlsSecretValid: true
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

    # Prometheus alerts source
    prometheus-alerts:
      displayName: "Prometheus Alerts"
      botkube/prometheus:
        enabled: true
        config:
          url: "http://kube-prometheus-stack-prometheus.monitoring:9090"
          alertStates:
            - firing
            - pending
          ignoreOldAlerts: true
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

    # CRD monitoring
    crds:
      displayName: "Custom Resources"
      botkube/kubernetes:
        enabled: true
        config:
          namespaces:
            include:
              - ".*"
          event:
            types:
              - create
              - delete
              - error
          resources:
            - name: monitoring.coreos.com/v1/podmonitors
            - name: monitoring.coreos.com/v1/servicemonitors
            - name: cert-manager.io/v1/certificates
            - name: argoproj.io/v1alpha1/applications
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

    # ArgoCD notifications - sync status, health changes
    argocd-notifications:
      displayName: "ArgoCD Notifications"
      botkube/kubernetes:
        enabled: true
        config:
          namespaces:
            include:
              - argocd
          event:
            types:
              - create
              - update
              - delete
              - error
          resources:
            # ArgoCD Application resources
            - type: argoproj.io/v1alpha1/applications
              event:
                types:
                  - create
                  - update
                  - delete
                  - error
            # ArgoCD ApplicationSet resources
            - type: argoproj.io/v1alpha1/applicationsets
              event:
                types:
                  - create
                  - update
                  - delete
                  - error
            # ArgoCD AppProject resources
            - type: argoproj.io/v1alpha1/appprojects
              event:
                types:
                  - create
                  - update
                  - delete
        context:
          rbac:
            group:
              type: Static
              static:
                values:
                  - botkube-plugins-default

  # NOTE: extraEnv for BOTKUBE_COMMUNICATIONS__* does NOT work for Slack tokens.
  # The env var override mechanism fails to properly apply to nested communication
  # config. Use AVP (ArgoCD Vault Plugin) to inject secrets directly into values.

# External Secrets Operator configuration
eso:
  enabled: true

# Node selector (optional)
nodeSelector: {}

# Tolerations (optional)
tolerations: []

# Affinity (optional)
affinity: {}
