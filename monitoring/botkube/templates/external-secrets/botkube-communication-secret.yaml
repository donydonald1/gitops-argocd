{{- if .Values.eso.enabled }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: botkube-communication-override
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault
  target:
    name: botkube-comm-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        comm_config.yaml: |
          # Communication settings - generated by External Secrets
          communications:
            default-group:
              teams:
                enabled: true
                appID: "{{ `{{ .teamsAppId }}` }}"
                appPassword: "{{ `{{ .teamsAppPassword }}` }}"
                botName: KubeBot
                port: 3978
                bindings:
                  executors:
                    - kubectl-read-only
                    - kubectl-full-access
                    - helm-readonly
                  sources:
                    - k8s-events
                    - k8s-errors
                    - k8s-recommendations
                    - prometheus-alerts
              slack:
                enabled: false
                channels:
                  default:
                    name: ""
                    bindings:
                      executors:
                        - kubectl-read-only
                      sources:
                        - k8s-events
              discord:
                enabled: false
              mattermost:
                enabled: false
              elasticsearch:
                enabled: false
              webhook:
                enabled: false
  data:
    - secretKey: teamsAppId
      remoteRef:
        key: secret/botkube
        property: teamsAppId
    - secretKey: teamsAppPassword
      remoteRef:
        key: secret/botkube
        property: teamsAppPassword
{{- end }}
