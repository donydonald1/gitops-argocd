{{- if .Values.eso.enabled }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: botkube-communication-override
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault
  target:
    name: botkube-comm-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        comm_config.yaml: |
          # Communication settings - generated by External Secrets from Vault
          communications:
            default-group:
              socketSlack:
                enabled: true
                botToken: "{{ `{{ .slackBotToken }}` }}"
                appToken: "{{ `{{ .slackAppToken }}` }}"
                channels:
                  # Main alerts channel - read-only access
                  default:
                    name: kubebot-alerts
                    bindings:
                      executors:
                        - kubectl-read-only
                      sources:
                        - k8s-errors
                        - k8s-critical
                        - k8s-nodes
                        - k8s-recommendations
                        - argocd-notifications
                  # Admin channel - full access for operations team
                  admin:
                    name: kubebot-admin
                    bindings:
                      executors:
                        - kubectl-full-access
                      sources:
                        - k8s-errors
                        - k8s-critical
                        - k8s-nodes
                        - crds
                        - argocd-notifications
              discord:
                enabled: false
              mattermost:
                enabled: false
              elasticsearch:
                enabled: false
              webhook:
                enabled: false
  data:
    - secretKey: slackBotToken
      remoteRef:
        key: secret/botkube
        property: slackBotToken
    - secretKey: slackAppToken
      remoteRef:
        key: secret/botkube
        property: slackAppToken
{{- end }}
