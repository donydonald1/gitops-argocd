# GitLab Agent for Kubernetes
# Agent connects to GitLab KAS server for cluster integration and workspaces

gitlab-agent:
  # Image configuration
  image:
    tag: v18.7.0-rc1
    pullPolicy: IfNotPresent

  # GitLab configuration
  config:
    # KAS address - using the GitLab KAS service
    kasAddress: "wss://kas.gitlab.techsecom.io"
    # kasAddress: "wss://gitlab.ops.techsecom.io/-/kubernetes-agent/"

    # Token secret name - references the secret created by ExternalSecret
    # The secret is created by templates/externalsecret.yaml with key 'token'
    secretName: gitlab-agent-token

  # Replicas for HA
  replicas: 2

  # Resource configuration
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Pod disruption budget
  podDisruptionBudget:
    enabled: true
    minAvailable: 1

  # Service account configuration - use our custom SA with cluster-admin
  serviceAccount:
    create: true
    name: gitlab-agent
    annotations: {}

  # RBAC - disabled here, using custom cluster-admin ClusterRole/Binding in templates/
  rbac:
    create: false  # We create our own cluster-admin RBAC in templates/cluster-admin-rbac.yaml

  # Observability
  observability:
    enabled: true
    logging:
      level: info

  # Pod-level security context (fsGroup is a pod-level field)
  podSecurityContext:
    fsGroup: 65534
    runAsNonRoot: true
    runAsUser: 65534

  # Container-level security context
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
