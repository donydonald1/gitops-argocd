# GitLab Agent for Kubernetes
# Agent connects to GitLab KAS server for cluster integration and workspaces

gitlab-agent:
  # Image configuration - match GitLab version (v18.8.x)
  image:
    tag: "v18.8.0"
    pullPolicy: IfNotPresent

  # GitLab configuration
  config:
    # KAS address - use internal service to bypass Cloudflare proxy
    # Port 8150 is the gRPC/WebSocket endpoint for agents
    kasAddress: "grpc://gitlab-kas.gitlab.svc.cluster.local:8150"

    # Token secret name - references the secret created by ExternalSecret
    # The secret is created by templates/externalsecret.yaml with key 'token'
    secretName: gitlab-agent-token

    # Observability settings (must be under config)
    observability:
      enabled: true
      # Enable gRPC logging for debugging
      logging:
        level: info
        grpc_level: warn

  # Replicas for HA
  replicas: 3

  # Resource configuration
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Service account configuration - use our custom SA with cluster-admin
  serviceAccount:
    create: true
    name: gitlab-agent
    annotations: {}

  # RBAC - disabled here, using custom cluster-admin ClusterRole/Binding in templates/
  rbac:
    create: false  # We create our own cluster-admin RBAC in templates/cluster-admin-rbac.yaml

  # Pod-level security context
  podSecurityContext:
    fsGroup: 65534
    runAsNonRoot: true
    runAsUser: 65534

  # Container-level security context
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
