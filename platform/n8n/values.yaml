# n8n - Workflow Automation Tool
# Production-Ready HA Configuration
# Documentation: https://docs.n8n.io/
# Chart: https://github.com/8gears/n8n-helm-chart

# Values for the n8n subchart (nested under dependency name)
n8n:
  # Image configuration
  image:
    repository: n8nio/n8n
    tag: "2.3.5"
    pullPolicy: IfNotPresent

  # Ingress configuration
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "100m"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
      # WebSocket support
      nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
      nginx.ingress.kubernetes.io/upgrade: "websocket"
      nginx.ingress.kubernetes.io/connection-upgrade: "true"
    hosts:
      - host: n8n.ops.techsecom.io
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: n8n-tls
        hosts:
          - n8n.ops.techsecom.io

  # Main n8n application configuration
  main:
    # n8n configuration via environment variables
    # See https://docs.n8n.io/hosting/configuration/environment-variables/
    config:
      db:
        type: postgresdb
        postgresdb:
          host: cnpg-cluster-rw.cnpg-system.svc.cluster.local
          port: 5432
          database: n8n
      executions:
        pruneData: "true"
        pruneDataMaxAge: 336  # 14 days in hours
      generic:
        timezone: America/Chicago
      n8n:
        host: n8n.ops.techsecom.io
        protocol: https
        metrics: true
        diagnostics:
          enabled: "false"

    # Secrets for n8n (passwords, encryption key)
    secret: {}
      # Secrets will come from External Secrets
      # db:
      #   postgresdb:
      #     password: ''
      # n8n:
      #   encryption_key: ''

    # Extra environment variables from secrets
    extraEnv:
      # Override N8N_PORT to avoid conflict with Kubernetes service env var
      N8N_PORT:
        value: "5678"
      DB_POSTGRESDB_USER:
        valueFrom:
          secretKeyRef:
            name: n8n-db-creds
            key: DB_POSTGRESDB_USER
      DB_POSTGRESDB_PASSWORD:
        valueFrom:
          secretKeyRef:
            name: n8n-db-creds
            key: DB_POSTGRESDB_PASSWORD
      N8N_ENCRYPTION_KEY:
        valueFrom:
          secretKeyRef:
            name: n8n-encryption-key
            key: N8N_ENCRYPTION_KEY

    # Persistence for n8n data
    persistence:
      enabled: true
      type: dynamic
      storageClass: nfs-csi
      size: 10Gi

    # Replica count (main instance - controller)
    replicaCount: 1

    # Deployment strategy
    deploymentStrategy:
      type: Recreate

    # Service account
    serviceAccount:
      create: true
      annotations: {}

    # Resources
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 2
        memory: 2Gi

    # Liveness probe
    livenessProbe:
      httpGet:
        path: /healthz
        port: http
      initialDelaySeconds: 30
      periodSeconds: 30
      timeoutSeconds: 10
      failureThreshold: 5

    # Readiness probe
    readinessProbe:
      httpGet:
        path: /healthz
        port: http
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3

    # Affinity - spread across nodes for HA
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - n8n
              topologyKey: kubernetes.io/hostname

    # Node selector
    nodeSelector: {}

    # Tolerations
    tolerations: []

  # Worker configuration (for queue mode scaling)
  worker:
    enabled: false  # Enable when using n8n enterprise with queue mode
    replicaCount: 2
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 2
        memory: 2Gi

  # Webhook handler configuration
  webhook:
    enabled: false  # Enable when using n8n enterprise with queue mode
    replicaCount: 2
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 1
        memory: 1Gi

  # Valkey/Redis configuration (for queue mode)
  valkey:
    enabled: false  # Enable when using queue mode
    architecture: standalone
    auth:
      enabled: false

# External Secrets Operator configuration (for wrapper chart templates)
eso:
  enabled: true
  vaultPath: n8n
