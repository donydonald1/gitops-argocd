keycloakx:
  nameOverride: keycloakx
  fullnameOverride: keycloakx
  replicas: 2

  image:
    tag: "26.4.5"

  # Enable health and metrics for monitoring
  health:
    enabled: true
  metrics:
    enabled: true

  command:
  - "/opt/keycloak/bin/kc.sh"
  - "--verbose"
  - "start"
  - "--import-realm"

  http:
    relativePath: "/"

  # HTTP and proxy settings (chart handles KC_PROXY_HEADERS and KC_HTTP_ENABLED)
  proxy:
    enabled: true
    mode: xforwarded
    http:
      enabled: true

  # Additional environment variables for Keycloak
  extraEnv: |
    - name: KC_HOSTNAME
      value: "https://keycloak.ops.techsecom.io"
    - name: KC_HOSTNAME_ADMIN
      value: "https://keycloak.ops.techsecom.io"
    - name: KC_SPI_EVENTS_LISTENER_JBOSS_LOGGING_SUCCESS_LEVEL
      value: "info"
    - name: KEYCLOAK_ADMIN
      valueFrom:
        secretKeyRef:
          name: keycloak-admin-creds
          key: username
    - name: KEYCLOAK_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: keycloak-admin-creds
          key: password
    - name: OIDC_CLIENT_ID
      valueFrom:
        secretKeyRef:
          name: keycloak-oidc-creds
          key: clientId
    - name: OIDC_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: keycloak-oidc-creds
          key: clientSecret
    - name: OIDC_ISSUER
      valueFrom:
        secretKeyRef:
          name: keycloak-oidc-creds
          key: issuer
    - name: OIDC_AUTH_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: keycloak-oidc-creds
          key: authEndpoint
    - name: OIDC_TOKEN_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: keycloak-oidc-creds
          key: tokenEndpoint
    - name: OIDC_USERINFO_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: keycloak-oidc-creds
          key: userInfoEndpoint
    - name: OIDC_JWKS_URI
      valueFrom:
        secretKeyRef:
          name: keycloak-oidc-creds
          key: jwksUri
    - name: OIDC_END_SESSION_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: keycloak-oidc-creds
          key: endSessionEndpoint
    - name: JAVA_OPTS_APPEND
      value: >-
        -XX:+UseContainerSupport
        -XX:MaxRAMPercentage=50.0
        -Djava.awt.headless=true
        -Djgroups.dns.query={{ include "keycloak.fullname" . }}-headless
        -Dkeycloak.connectionsHttpClient.default.expect-continue-enabled=true
        -Dkeycloak.connectionsHttpClient.default.reuse-connections=false

  # Volume mounts for realm import
  extraVolumeMounts: |
    - name: realm-config
      mountPath: /opt/keycloak/data/import
      readOnly: true

  # Volumes for realm import ConfigMap
  extraVolumes: |
    - name: realm-config
      configMap:
        name: keycloak-realm-config

  # Pod annotations for Stakater Reloader
  podAnnotations:
    reloader.stakater.com/auto: "true"

  # Ingress configuration - API endpoints on keycloak-api.ops.techsecom.io
  ingress:
    enabled: true
    annotations:
      nginx.ingress.kubernetes.io/proxy-buffer-size: 256k
      nginx.ingress.kubernetes.io/proxy-body-size: "10m"
      cert-manager.io/cluster-issuer: letsencrypt-prod
    ingressClassName: "nginx"
    hostname: keycloak-api.ops.techsecom.io
    servicePort: http
    rules:
    - host: keycloak-api.ops.techsecom.io
      paths:
      - path: /
        pathType: Prefix
    tls:
    - secretName: keycloak-api-tls-secret
      hosts:
      - keycloak-api.ops.techsecom.io
    # Disable built-in console ingress (using custom template)
    console:
      enabled: false

  # Production resources
  resources:
    limits:
      memory: "2048Mi"
      cpu: "1000m"
    requests:
      cpu: "200m"
      memory: "512Mi"

  # Check database readiness at startup
  dbchecker:
    enabled: true
    securityContext:
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      runAsUser: 1000

  # External PostgreSQL - CNPG Cluster
  database:
    vendor: postgres
    existingSecret: keycloak-db-creds
    existingSecretKey: password
    hostname: cnpg-cluster-pooler-rw.cnpg-system.svc.cluster.local
    port: 5432
    database: keycloak
    username: keycloak

  # Autoscaling configuration
  autoscaling:
    enabled: true
    labels: {}
    minReplicas: 2
    maxReplicas: 5
    metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 80
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
        - type: Pods
          value: 1
          periodSeconds: 300

  # Pod Disruption Budget
  podDisruptionBudget:
    maxUnavailable: 1

  # Service Monitor for Prometheus
  serviceMonitor:
    enabled: true
    labels:
      release: kps

# Custom console ingress configuration (keycloak.ops.techsecom.io)
consoleIngress:
  enabled: true
  ingressClassName: "nginx"
  hostname: keycloak.ops.techsecom.io
  annotations:
    nginx.ingress.kubernetes.io/proxy-buffer-size: 256k
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    cert-manager.io/cluster-issuer: letsencrypt-prod
  tls:
  - secretName: keycloak-tls-secret
    hosts:
    - keycloak.ops.techsecom.io

# Disable embedded PostgreSQL - using external CNPG
pgo:
  enabled: false

# Configure External Secrets Operator
eso:
  enabled: true
  type: "vault"
  secretStoreName: "vault"
  secretName: "keycloak"
