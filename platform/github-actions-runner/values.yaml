# =============================================================================
# GitHub Actions Runner Controller Configuration
# =============================================================================
# This chart deploys:
# 1. ARC Controller - manages runner scale sets
# 2. Runner Scale Set - organization-level runners for Techsecom
# =============================================================================

# -----------------------------------------------------------------------------
# ARC Controller Configuration
# -----------------------------------------------------------------------------
controller:
  # Controller replicas for HA
  replicaCount: 1

  # Image configuration
  image:
    repository: ghcr.io/actions/gha-runner-scale-set-controller
    pullPolicy: IfNotPresent

  # Service account
  serviceAccount:
    create: true
    name: "gha-rs-controller"

  # Resource limits
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Pod priority
  priorityClassName: ""

  # Tolerations for controller
  tolerations: []

  # Node selector
  nodeSelector: {}

  # Affinity rules
  affinity: {}

  # Metrics configuration
  metrics:
    controllerManagerAddr: ":8080"
    listenerAddr: ":8080"
    listenerEndpoint: "/metrics"

  # Logging
  logLevel: info
  logFormat: text

# -----------------------------------------------------------------------------
# Runner Scale Set Configuration
# -----------------------------------------------------------------------------
runners:
  # GitHub configuration - uses secret from ExternalSecrets
  githubConfigUrl: "https://github.com/Techsecom"

  # Secret name containing GitHub PAT (created by ExternalSecret)
  # The secret must have 'github_token' key with a PAT that has 'repo' and 'admin:org' scopes
  githubConfigSecret: github-runner-token

  # Runner name in GitHub UI
  runnerScaleSetName: "techsecom-k8s-runners"

  # Min/Max runners
  minRunners: 1
  maxRunners: 100

  # Runner group (optional - for enterprise)
  # runnerGroup: "default"

  # Container mode - runs jobs in containers
  containerMode:
    type: "kubernetes"
    kubernetesModeWorkVolumeClaim:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "longhorn"
      resources:
        requests:
          storage: 10Gi

  # Template for runner pods
  # Note: Job pods are configured separately via hook-extension ConfigMap.
  # The hook extension adds ServiceAccount (gha-runner-deploy) and kubectl
  # to job pods for CI/CD deploy steps.
  template:
    spec:
      containers:
      - name: runner
        image: ghcr.io/actions/actions-runner:latest
        imagePullPolicy: IfNotPresent
        command: [ "/home/runner/run.sh" ]
        env:
        - name: ACTIONS_RUNNER_CONTAINER_HOOKS
          value: /home/runner/k8s/index.js
        - name: ACTIONS_RUNNER_CONTAINER_HOOK_TEMPLATE
          value: /home/runner/pod-templates/content
        - name: ACTIONS_RUNNER_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: ACTIONS_RUNNER_REQUIRE_JOB_CONTAINER
          value: "false"
        resources:
          limits:
            cpu: "2"
            memory: 4Gi
          requests:
            cpu: 500m
            memory: 1Gi
        volumeMounts:
        - name: work
          mountPath: /home/runner/_work
        - name: pod-template
          mountPath: /home/runner/pod-templates
          readOnly: true

      volumes:
      - name: work
        emptyDir: {}
      - name: pod-template
        configMap:
          name: hook-extension

  # Listener pod configuration
  listenerTemplate:
    spec:
      containers:
      - name: listener
        resources:
          limits:
            cpu: 250m
            memory: 256Mi
          requests:
            cpu: 50m
            memory: 64Mi

  # Controller service account reference
  controllerServiceAccount:
    namespace: github-actions-runner
    name: gha-rs-controller
