# Atlantis - Terraform Pull Request Automation for GitLab
# Production-Ready Configuration
# Documentation: https://www.runatlantis.io/docs/

atlantis:
  # Secret containing GitLab credentials (created via External Secrets)
  vcsSecretName: atlantis-vcs-secret

  # GitLab configuration
  gitlab:
    user: atlantis
    hostname: gitlab.ops.techsecom.io

  # Ingress configuration
  ingress:
    enabled: true
    ingressClassName: nginx
    path: /
    pathType: Prefix
    host: atlantis.ops.techsecom.io
    annotations:
      # Homepage dashboard integration
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: "Atlantis"
      gethomepage.dev/description: "Terraform PR Automation"
      gethomepage.dev/group: "Platform"
      gethomepage.dev/icon: "https://raw.githubusercontent.com/runatlantis/atlantis/main/runatlantis.io/public/hero.png"
      gethomepage.dev/href: "https://atlantis.ops.techsecom.io"
      gethomepage.dev/pod-selector: "app=atlantis"
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      # Rate limiting for security
      nginx.ingress.kubernetes.io/limit-rps: "10"
      nginx.ingress.kubernetes.io/limit-connections: "5"
    tls:
      - secretName: atlantis-tls
        hosts:
          - atlantis.ops.techsecom.io

  # Image configuration - using official Atlantis image
  image:
    repository: ghcr.io/runatlantis/atlantis
    tag: ""  # Uses appVersion from Chart.yaml (v0.39.0)
    pullPolicy: IfNotPresent

  # GitLab organization/group allowlist
  # Format: gitlab.hostname/owner/repo or gitlab.hostname/owner/* for all repos in a group
  orgAllowlist: gitlab.ops.techsecom.io/*

  # Default Terraform version
  defaultTFVersion: "1.10.0"

  # Production safety settings
  disableApplyAll: true

  # Enable diff markdown format for better readability
  enableDiffMarkdownFormat: true

  # Hide previous plan comments to reduce clutter
  hidePrevPlanComments: true

  # Repository configuration - Production settings
  repoConfig: |
    ---
    repos:
    - id: /.*/
      allowed_overrides:
        - workflow
        - apply_requirements
        - delete_source_branch_on_merge
      allow_custom_workflows: true
      apply_requirements:
        - approved
        - mergeable
      # Auto-merge after successful apply
      delete_source_branch_on_merge: true

  # Additional environment variables - Production settings
  environment:
    # Vault configuration for Terraform providers
    VAULT_ADDR: "https://vault.vault.svc.cluster.local:8200"
    VAULT_SKIP_VERIFY: "true"
    # Enable parallel plan/apply for better performance
    ATLANTIS_PARALLEL_PLAN: "true"
    ATLANTIS_PARALLEL_APPLY: "true"
    # Automerge after successful apply
    ATLANTIS_AUTOMERGE: "true"
    # Silence VCS status comments (less noise)
    ATLANTIS_SILENCE_VCS_STATUS_NO_PROJECTS: "true"
    # Write git credentials for private module access
    ATLANTIS_WRITE_GIT_CREDS: "true"
    # Lock on plan to prevent concurrent modifications
    ATLANTIS_AUTOPLAN_FILE_LIST: "**/*.tf,**/*.tfvars,**/*.tfvars.json"
    # Emoji reactions for better UX
    ATLANTIS_EMOJI_REACTION: "true"
    # Maximum concurrent jobs
    ATLANTIS_PARALLEL_POOL_SIZE: "5"

  # Note: ATLANTIS_GITLAB_TOKEN and ATLANTIS_GITLAB_WEBHOOK_SECRET are automatically
  # set by the upstream chart when vcsSecretName is configured (see above)

  # Environment variables from secrets (AWS/S3 credentials for MinIO backend)
  environmentSecrets:
    - name: AWS_ACCESS_KEY_ID
      secretKeyRef:
        name: atlantis-vcs-secret
        key: aws_access_key_id
    - name: AWS_SECRET_ACCESS_KEY
      secretKeyRef:
        name: atlantis-vcs-secret
        key: aws_secret_access_key
    # Vault AppRole credentials for Terraform providers (accessing kubeconfig secrets)
    - name: VAULT_ROLE_ID
      secretKeyRef:
        name: atlantis-vcs-secret
        key: vault_role_id
    - name: VAULT_SECRET_ID
      secretKeyRef:
        name: atlantis-vcs-secret
        key: vault_secret_id

  # Service account
  serviceAccount:
    create: true
    annotations: {}

  # Production resource limits
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 2
      memory: 2Gi

  # Persistence for Atlantis data (plans, locks)
  dataStorage: 10Gi
  storageClassName: longhorn

  # StatefulSet configuration for production
  statefulSet:
    annotations: {}
    labels:
      app.kubernetes.io/part-of: atlantis
      app.kubernetes.io/component: terraform-automation

  # Pod template configuration
  podTemplate:
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "4141"
      prometheus.io/path: "/metrics"
    labels:
      app.kubernetes.io/part-of: atlantis
      app.kubernetes.io/component: terraform-automation

  # Liveness and readiness probes - Production tuned
  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 60
    timeoutSeconds: 10
    failureThreshold: 5
    successThreshold: 1
  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1

  # Service configuration
  service:
    type: ClusterIP
    port: 80
    targetPort: 4141
    annotations: {}

  # Node selector for dedicated nodes (optional)
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity rules
  affinity: {}

  # Topology spread constraints
  topologySpreadConstraints: []

  # Additional volumes (for custom scripts, etc.)
  extraVolumes: []
  extraVolumeMounts: []

  # Init containers (for setup tasks)
  # Fix terraform binary permissions and clean up stale BoltDB locks
  initContainers:
    - name: fix-terraform-permissions
      image: busybox:latest
      command:
        - sh
        - -c
        - |
          echo "Listing data directory contents..."
          ls -la /atlantis-data/
          echo "Removing any stale BoltDB lock files..."
          rm -f /atlantis-data/*.db.lock /atlantis-data/atlantis.db.lock 2>/dev/null || true
          # Also check for flock files in the db directory
          find /atlantis-data -name "*.lock" -delete 2>/dev/null || true
          find /atlantis-data -name "*.db" -exec flock -u {} \; 2>/dev/null || true
          echo "Ensuring /atlantis-data/bin directory exists with proper permissions..."
          mkdir -p /atlantis-data/bin
          chmod 755 /atlantis-data/bin
          if ls /atlantis-data/bin/terraform* 1>/dev/null 2>&1; then
            echo "Fixing execute permissions on existing terraform binaries..."
            chmod +x /atlantis-data/bin/terraform*
            ls -la /atlantis-data/bin/
          else
            echo "No terraform binaries found yet, will be downloaded on first use"
          fi
          echo "Init container completed"
      volumeMounts:
        - name: atlantis-data
          mountPath: /atlantis-data

  # Common labels applied to all resources
  commonLabels:
    app.kubernetes.io/part-of: atlantis
    environment: production

  # Lifecycle hooks to fix terraform binary permissions after download
  lifecycle:
    postStart:
      exec:
        command:
          - sh
          - -c
          - |
            # Background process to fix terraform binary permissions
            (while true; do
              if ls /atlantis-data/bin/terraform* 1>/dev/null 2>&1; then
                chmod +x /atlantis-data/bin/terraform* 2>/dev/null || true
              fi
              sleep 30
            done) &

# External Secrets Operator configuration for Vault integration
eso:
  # Enable External Secrets
  enabled: true
  # Path in Vault where Atlantis secrets are stored
  # Expected keys: gitlab_token, gitlab_webhook_secret
  vaultPath: atlantis

# Pod Disruption Budget for high availability
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network Policy for production security
networkPolicy:
  enabled: true
