imageName: ghcr.io/cloudnative-pg/postgresql:17.6

instances: 3
computeSizeFactor: 4

affinity: {}

# PostgreSQL pod resources - increased for GitLab performance
resources:
  requests:
    memory: 4Gi
    cpu: 2
  limits:
    memory: 16Gi
    cpu: 8

# Pooler pod resources - increased for connection handling
poolerResources:
  requests:
    memory: 512Mi
    cpu: 500m
  limits:
    memory: 2Gi
    cpu: 2
annotations:
  argocd.argoproj.io/sync-wave: "-1"
  argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
# Connection allocation strategy
# Total max_connections will be calculated from memory, then distributed:
connections:
  # Reserved connections: CNPG replication, monitoring, migrations, psql, pgAdmin, maintenance
  # Includes superuser access, background workers, and emergency access
  # Recommended minimum: 10
  reserved: 10
  # Pooler connections: For application connections via PgBouncer
  # Set to 0 to disable pooler, set to "auto" to allocate remaining connections
  # Cannot be "auto" if direct is also "auto"
  pooler: auto
  # Direct connections: Uses internal connection pooling
  # Set to "auto" to allocate remaining connections after reserved and pooler
  # Cannot be "auto" if pooler is also "auto"
  # Automatically calculated as: max_connections - reserved - pooler
  # direct: auto

storageClass: longhorn
storageSize: 100Gi
maxConnections: 2000
objectStore:
  endpoint: http://minio.minio.svc.cluster.local:9000
  bucketName: postgres
  s3CredentialsSecretName: aws-credentials
  s3AccessKeyIdSecretKey: accessKeyId
  s3SecretAccessKeySecretKey: secretAccessKey

backup:
  enabled: true
  schedule: ""
SuperuserSecret: postgres-superuser-secret
recovery:
  # ========================================================================
  # DISASTER RECOVERY MODES
  # ========================================================================
  #
  # Mode 1: "fresh" - Create new cluster with fresh data
  # Mode 2: "production" - Use recovery bootstrap (prevents fresh cluster creation)
  # Mode 3: "recovery" - Recover from specific timeline
  #
  mode: "fresh" # Options: fresh, production, recovery
  # https://cloudnative-pg.io/documentation/current/recovery/#recovery-targets
  target: {}
  # Timeline configuration
  timeline:
    # Source reader timeline (set to writer timeline after successful recovery)
    # This makes future recoveries easier by avoiding timeline searches
    reader: ""
    # Current writer timeline (update this for disaster recovery)
    # Format: ISO 8601 timestamp (e.g., "2025-09-23T14:59:00+08:00")
    writer: "2025-10-03T14:59:00+08:00"

monitoring:
  enabled: true
  podMonitor:
    enabled: true
    # relabelings: []

    # metricRelabelings: []
  prometheusRule:
    enabled: true
    # excludeRules: []


managedRoles:
# BuyCheapNow E-commerce Platform
- name: buycheapnow
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: buycheapnow-user-secret

- name: grafana
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: grafana-user-secret

- name: wikijs
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: wikijs-user-secret

- name: harbor
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: harbor-user-secret

- name: gitlab
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: gitlab-user-secret

- name: praefect
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: praefect-user-secret

- name: reportportal
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: reportportal-user-secret

- name: keycloak
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: keycloak-user-secret

- name: defectdojo
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: defectdojo-user-secret

- name: n8n
  ensure: present
  login: true
  createrole: true
  bypassrls: true
  passwordSecret:
    name: n8n-user-secret

pooler:
  maxDbConnections: 2000
  maxClientConn: 2000
  rw:
    enabled: true
    instances: 1
    mode: transaction
    maxDbConnections: 2000
  ro:
    enabled: true
    instances: 1
    mode: transaction
    maxDbConnections: 2000
postgresql:
  maxConnectionsOverride: 2000
  # Performance tuning for GitLab workload
  parameters:
    # Memory settings (tuned for 16GB limit)
    shared_buffers: "4GB"
    effective_cache_size: "12GB"
    work_mem: "64MB"
    maintenance_work_mem: "1GB"
    # WAL settings for performance
    wal_buffers: "64MB"
    max_wal_size: "4GB"
    min_wal_size: "1GB"
    checkpoint_completion_target: "0.9"
    # Query planner settings
    random_page_cost: "1.1"
    effective_io_concurrency: "200"
    # Parallelism
    max_worker_processes: "8"
    max_parallel_workers_per_gather: "4"
    max_parallel_workers: "8"
    max_parallel_maintenance_workers: "4"
    # Connection settings
    idle_in_transaction_session_timeout: "30min"
    statement_timeout: "60min"
