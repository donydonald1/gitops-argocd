clickhouse:
  # Use bitnamilegacy for available images
  image:
    registry: docker.io
    repository: bitnamilegacy/clickhouse
    pullPolicy: IfNotPresent

  # Cluster name
  clusterName: gitlab

  # Authentication
  auth:
    username: gitlab
    existingSecret: clickhouse-auth
    existingSecretKey: password

  # HA Configuration: 2 shards x 2 replicas = 4 ClickHouse nodes
  shards: 1
  replicaCount: 3

  # Enable ClickHouse Keeper for coordination (required for replication)
  keeper:
    enabled: true
    replicaCount: 3
    image:
      registry: docker.io
      repository: bitnamilegacy/clickhouse-keeper
    persistence:
      enabled: true
      storageClass: longhorn
      size: 10Gi
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
  # Zookeeper disabled - using Keeper instead
  zookeeper:
    enabled: false

  # Resources
  resources:
    requests:
      cpu: 500m
      memory: 2Gi
    limits:
      cpu: 4
      memory: 16Gi

  # Persistence
  persistence:
    enabled: true
    storageClass: longhorn
    size: 100Gi

  # Service
  service:
    type: ClusterIP

  # Pod anti-affinity for HA
  podAntiAffinityPreset: soft

  # Startup/liveness/readiness probes with generous timeouts
  startupProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 30
    successThreshold: 1

  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6
    successThreshold: 1

  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6
    successThreshold: 1

  # Disable volume permissions globally (chart bug with empty volume name for keeper)
  defaultInitContainers:
    volumePermissions:
      enabled: false

  # Extra configuration for gitlab user grants
  extraOverrides: |
    <clickhouse>
      <users>
        <gitlab>
          <access_management>0</access_management>
        </gitlab>
      </users>
    </clickhouse>
